# メール通知が届かない場合のデバッグガイド

## 問題の確認手順

### 1. PM2のログを確認

```bash
pm2 logs hare2 --lines 200 | grep -E "(メール|email|キュー|queue|通知|notification)"
```

### 2. 確認すべきログメッセージ

#### 正常に動作している場合

以下のログが表示されるはずです：

```
[watch] 通知送信: StockIncreased [identity] 在庫0→1
[watch] メール通知をキューに追加: [コレクション名] (キューサイズ: 1, eventType=StockIncreased)
[watch] [コレクション名] のバッチメール送信開始 (1件)
[email] メール送信成功: <message-id>
[watch] [コレクション名] のバッチメール送信完了
```

#### 問題がある場合

以下のログが表示される可能性があります：

```
[watch] [コレクション名] のキューは空（通知なし）
```
→ 通知が検知されていない、またはキューに追加されていない

```
[watch] メール通知キューに追加失敗: collectionNameが不明
```
→ `collectionName`が正しく渡されていない

```
[watch] [コレクション名] のバッチメール送信失敗: [エラーメッセージ]
```
→ メール送信時にエラーが発生している

### 3. 検知ロジックのテスト

ローカルで検知ロジックをテスト：

```bash
npm run test:detection-logic
```

このテストは以下を確認します：
- 商品の状態がRedisに正しく保存されているか
- 変更が検知されるか
- 通知が送信されるべきかどうか

### 4. メール送信のテスト

ローカルでメール送信をテスト：

```bash
npm run test:email-simple
```

このテストは以下を確認します：
- SMTP設定が正しいか
- メールが実際に送信されるか

### 5. 本番処理フローのテスト

ローカルで本番処理フローを再現：

```bash
npm run test:production-email-flow
```

このテストは以下を確認します：
- 実際の商品データを使用して、本番と同じ処理フローを実行
- メールが送信されるか

## よくある問題と解決方法

### 問題1: キューに通知が追加されない

**原因:**
- `collectionName`が正しく渡されていない
- 変更が検知されていない（初回検知として扱われている）

**解決方法:**
1. PM2のログで`[watch] メール通知キューに追加失敗`を確認
2. `collectionName`が正しく設定されているか確認
3. Redisの状態を確認（`redis-cli`で`product_state:*`を確認）

### 問題2: メール送信エラー

**原因:**
- SMTP設定が間違っている
- アプリパスワードが正しく設定されていない
- ネットワークエラー

**解決方法:**
1. PM2のログでエラーメッセージを確認
2. `.env`ファイルのSMTP設定を確認
3. Gmailのアプリパスワードが正しく設定されているか確認

### 問題3: 変更が検知されない

**原因:**
- 初回検知として扱われている（状態が保存されていない）
- スリープ時間が長すぎて、変更を検知する前に状態が更新されている

**解決方法:**
1. Redisの状態を確認
2. スリープ時間を調整（`SLEEP_BETWEEN_*`環境変数）
3. コレクション処理間隔を確認（`HOT_INTERVAL_SEC`など）

### 問題4: キューキーが一致しない

**原因:**
- `collectionName`とキューキーが一致していない
- URLから推測したキューキーが使用されている

**解決方法:**
1. PM2のログで`[watch] [コレクション名] のキューは空（他のキュー: ...）`を確認
2. キューキーが`collection.name`と一致しているか確認
3. `handleProduct`に`collectionName`が正しく渡されているか確認

## デバッグ用環境変数

以下の環境変数を設定すると、より詳細なログが出力されます：

```bash
DEBUG=true  # より詳細なログを出力（実装が必要）
```

## 緊急時の確認コマンド

```bash
# PM2の状態確認
pm2 status

# PM2のログ確認（最新100行）
pm2 logs hare2 --lines 100

# Redisの状態確認
redis-cli
> KEYS product_state:*
> HGETALL product_state:[identity]

# メール送信テスト
npm run test:email-simple
```



