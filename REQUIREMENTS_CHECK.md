# 要件チェック結果と対応内容

## ✅ 実装済み

### 【現在GASで実施していること】
1. ✅ **一覧ページから商品ページのURLを拾う**
   - `src/collection.js`で実装済み
   - HTMLパースで`/products/`リンクを抽出

2. ✅ **商品ごとの在庫を公式のJSONから取る**
   - `src/product.js`で実装済み
   - `/products/{handle}.js`からShopify JSONを取得
   - 商品名と在庫数を取得

3. ⚠️ **在庫の追加を通知**
   - Slack通知は実装済み（`src/slack.js`）
   - **不足: メール通知が未実装**

4. ✅ **通知に商品名と前回在庫数を記載**
   - Slack通知に含まれている

### 【バグ対応】
2. ✅ **特定の商品を繰り返し通知してしまう**
   - 重複防止機能を実装済み（`dedupeCooldownSec`）
   - eventIdベースでクールダウン（既定180秒）

---

## ❌ 不足している機能と対応内容

### 1. 【現在GASで実施していること】- メール通知 ✅ 実装済み

**現状:**
- ✅ `src/email.js`を作成済み
- ✅ SMTP設定（Gmail/SendGrid等）を環境変数で設定済み
- ✅ `src/watch.js`と`src/oneshot.js`でメール送信を追加済み
- ✅ メール本文フォーマットをSlackと同じ形式に統一済み

**実装内容:**
- `EMAIL_ENABLED=true`でメール通知を有効化
- `EMAIL_SMTP_HOST`, `EMAIL_SMTP_PORT`, `EMAIL_SMTP_USER`, `EMAIL_SMTP_PASSWORD`でSMTP設定
- `EMAIL_FROM`, `EMAIL_TO`で送信元・送信先を指定

**実装優先度: 中** ✅ 完了

---

### 2. 【現在GASで実施していること】- 複数コレクション対応（16ブロック）

**現状:**
- 1つのコレクション（PMCG）のみ対応
- 環境変数`TARGET_COLLECTION_BASE`で1つだけ指定可能

**対応内容:**
- `src/config.js`に複数コレクション設定を追加
  ```javascript
  collections: [
    { name: 'PMCG', base: 'https://...', pages: [1,2,3] },
    { name: 'SV-P', base: 'https://...', pages: [1,2,3] },
    // ... 16ブロック分
  ]
  ```
- `src/watch.js`の`mainLoop`で全コレクションをループ処理
- 各コレクションごとに優先度付きスケジューリング

**実装優先度: 高**

---

### 3. 【現在GASで実施していること】- 全53ページ対応

**現状:**
- `PAGES=1,2,3`で3ページのみ対応
- 全53ページの監視が未実装

**対応内容:**
- 動的ページ数検出機能を追加
  - 一覧ページの最後のページ番号を自動検出（`<a>次</a>`リンクやページネーションから）
- または、環境変数で全ページを明示的に指定
  ```env
  PAGES=1,2,3,4,5,...,53
  ```
- 優先度付きスケジューリング
  - page1-3: 高頻度（20秒間隔）
  - page4-10: 中頻度（60秒間隔）
  - page11-53: 低頻度（300秒間隔）

**実装優先度: 高**

---

### 4. 【バグ】- 在庫が増加していない商品も増加したと検知

**現状:**
- `product.totalStock > prevStock`で厳密にチェックしているが、テストが必要
- 在庫数の揺らぎ（一時的な不整合）への対策が未実装

**対応内容:**
- 連続2回の読み取りで整合性確認（バウンシング抑制）
- 在庫数の変化が1以上の場合のみ通知（`delta >= 1`を明示的にチェック）
- ログに詳細な比較情報を出力してデバッグ可能にする

**実装優先度: 高**

---

### 5. 【バグ】- 目視で確認した際に増加している商品の通知が来ない

**現状:**
- 実装では検知しているが、以下が原因の可能性:
  - 一覧ページのハッシュが変化していない場合、商品JSONを取得しない
  - 重複防止キーが残っている

**対応内容:**
- page1は常に商品JSONを取得（ハッシュ変化に関係なく）
- 重複防止キーのTTLを短縮（60秒→30秒）または、在庫数が変わった場合は新しいeventIdを生成
- ログに「検知したが通知しなかった」理由を出力

**実装優先度: 高**

---

### 6. 【はれるや2bot 構想】- 在庫減少・売り切れ通知 ✅ 実装済み

**現状:**
- ✅ `src/watch.js`と`src/oneshot.js`の`handleProduct`に実装済み
- ✅ 環境変数で有効/無効を切り替え可能

**実装内容:**
- `NOTIFY_STOCK_DECREASE=true`で在庫減少通知を有効化
- `NOTIFY_SOLD_OUT=true`で売り切れ通知を有効化
- `StockDecreased`と`SoldOut`イベントタイプを追加

**実装優先度: 中** ✅ 完了

---

### 7. 【はれるや2bot 構想】- 新規高額カードページ検知（#1384形式） ✅ 実装済み

**現状:**
- ✅ `src/product.js`に`extractHashNumber`関数を追加済み
- ✅ 商品の同定キーに`#数字4桁`を含める実装済み
- ✅ `NewHighPricePage`イベントタイプを追加済み
- ✅ 既存商品の`#数字4桁`が変わった場合も検知済み

**実装内容:**
- タイトルから`#数字4桁`を抽出（例: "#1384" → "1384"）
- 同じカードの別ページ（#1384 vs #1415）を区別するため、identityにhashNumberを含める
- 初回検知時、またはhashNumberが変わった場合に`NewHighPricePage`イベントとして通知

**実装優先度: 中** ✅ 完了

---

### 8. 【はれるや2bot 構想】- 在庫履歴と新規判定ロジック

**現状:**
- Redisに最後の状態のみ保存
- 履歴は保存していない

**対応内容:**
- Redisに履歴を保存（Sorted Setを使用）
  ```javascript
  // キー: inventory_history:{identity}
  // 値: timestamp:stock:price の形式で保存
  await redis.zadd(`inventory_history:${identity}`, Date.now(), `${now}:${stock}:${price}`);
  ```
- 新規判定ロジック
  - `firstSeenAt`が24時間以内 → `NewArrival`
  - `firstSeenAt`が24時間以上前で、在庫0→1以上 → `Restock`
- 通知メッセージに判定結果を含める

**実装優先度: 低**

---

### 9. 【その他設定】- 実行上限時間・リクエスト回数の制御

**現状:**
- 常駐実行で制限時間の概念がない
- リクエスト回数の集計・制御が未実装

**対応内容:**
- リクエストカウンターをRedisで管理
  ```javascript
  // キー: request_count:{date}
  // 1日あたりのリクエスト数をカウント
  const count = await redis.incr(`request_count:${today}`);
  if (count > 20000) {
    // リクエスト制限に達したら待機
  }
  ```
- 実行時間の監視とアラート
- 複数インスタンスでの分散実行（時間帯ごとの担当分け）

**実装優先度: 低**

---

### 10. 【はれるや2bot 構想】- 自動購入機能

**現状:**
- 未実装

**対応内容:**
- 別プロジェクトとして実装を検討
- 認証・CSRF対策・決済処理が必要
- 人間の最終確認ワークフローが必要

**実装優先度: 低（将来の拡張）**

---

## 📋 実装優先順位まとめ

### 優先度: 高（すぐに対応）
1. 複数コレクション対応（16ブロック）
2. 全53ページ対応
3. バグ修正: 在庫増加の誤検知対策
4. バグ修正: 通知が来ない問題の対策

### 優先度: 中（次に対応）
5. メール通知の実装
6. 在庫減少・売り切れ通知
7. 新規高額カードページ検知（#1384形式）

### 優先度: 低（将来的に対応）
8. 在庫履歴と新規判定ロジック
9. 実行上限時間・リクエスト回数の制御
10. 自動購入機能

---

## 🧪 テスト項目

### 必須テスト
- [ ] 在庫増加の正確な検知（誤検知がないか）
- [ ] 重複通知の防止（同じ商品が繰り返し通知されないか）
- [ ] 通知が確実に届く（検知した商品が通知されるか）
- [ ] 複数コレクションの並列処理
- [ ] 全53ページの処理（パフォーマンステスト）

### 推奨テスト
- [ ] 在庫減少・売り切れ通知
- [ ] 新規高額カードページ検知
- [ ] メール通知の送信
- [ ] リクエスト回数の制御

